# 要件書

## はじめに

Water-Info-Acquirerプロジェクトの既存機能を維持しながら、保守性・拡張性・信頼性を向上させるためのリファクタリングを実施します。このリファクタリングは、重複ロジックの排除、責務分離、テスト容易性の確保、運用性の改善、将来の拡張に耐えるパッケージ構造への再編を目的としています。

## 要件

### 要件1：データ取得コアの統合

**ユーザーストーリー：** 開発者として、日次・時間次データ取得の重複ロジックを統合したいので、保守性を向上させたい

#### 受入基準

1. WHEN 日次・時間次データ取得が実行される THEN システムは共通のAPIを使用してデータを取得する SHALL
2. WHEN モード（水位・流量・雨量）が指定される THEN システムは統一されたマッピングテーブルからURL・ラベル・単位を取得する SHALL
3. WHEN 観測所名の抽出が実行される THEN システムは共通の抽出ロジックを使用する SHALL
4. WHEN HTML抽出が実行される THEN システムは `get_text(strip=True)` を基準として使用する SHALL
5. WHEN 数値化処理が実行される THEN システムは `pd.to_numeric(errors="coerce")` を基準として使用する SHALL
6. WHEN 新しいAPIで既存処理を置換する THEN 出力Excelのデータ点は既存と一致する SHALL

### 要件2：Excel出力の共通化

**ユーザーストーリー：** 開発者として、Excel出力処理を共通化したいので、重複コードを削減し保守性を向上させたい

#### 受入基準

1. WHEN Excel出力が実行される THEN システムは全期間・年別・summaryの出力を共通レイヤで処理する SHALL
2. WHEN 散布図の挿入が実行される THEN システムは軸・凡例・サイズの共通設定を使用する SHALL
3. WHEN 新しいExcel出力APIが使用される THEN 既存Excelとシート名・列名・チャート有無が一致する SHALL
4. WHEN single-sheetモードが指定される THEN システムは1シートに全データを出力してチャートを挿入する SHALL

### 要件3：GUI分離

**ユーザーストーリー：** 開発者として、GUIとビジネスロジックを分離したいので、テスト容易性と保守性を向上させたい

#### 受入基準

1. WHEN GUIが起動される THEN システムはUIコンポーネントを独立したモジュールで管理する SHALL
2. WHEN GUI操作が実行される THEN システムは統合されたデータ取得・Excel出力APIを呼び出す SHALL
3. WHEN GUI経由でExcel生成が実行される THEN 従来と同等のExcelファイルが生成される SHALL
4. WHEN CLIエントリーポイントが使用される THEN `__main__.py` の入口は変更されない SHALL

### 要件4：エラーハンドリングとログ機能

**ユーザーストーリー：** 運用者として、適切なログとエラーハンドリングが欲しいので、問題の原因を追跡できるようにしたい

#### 受入基準

1. WHEN システムが動作する THEN 標準的なloggingモジュールを使用してINFO・ERRORレベルのログを出力する SHALL
2. WHEN ログが出力される THEN ファイルとコンソールの両方に出力される SHALL
3. WHEN 業務例外（空データ等）が発生する THEN GUIではポップアップ、CLIでは非ゼロ終了コードとメッセージを表示する SHALL
4. WHEN 想定外例外が発生する THEN ログに記録し、短文で通知する SHALL
5. WHEN CLI・GUI双方で例外が発生する THEN 一貫した挙動を示す SHALL

### 要件5：パッケージ構造の再編

**ユーザーストーリー：** 開発者として、将来の拡張に耐えるパッケージ構造にしたいので、モジュール間の依存関係を明確にしたい

#### 受入基準

1. WHEN パッケージ構造が変更される THEN `src/wia/` 配下に機能別モジュールが配置される SHALL
2. WHEN モジュールが分離される THEN data_source.py、excel_writer.py、gui.py、errors.py、constants.py、types.py が作成される SHALL
3. WHEN パッケージ移行が完了する THEN `python -m src.__main__` が正常に動作する SHALL
4. WHEN PyInstallerビルドが実行される THEN 現行ワークフローが成功する SHALL

### 要件6：最小テストの導入

**ユーザーストーリー：** 開発者として、基本的なテストを導入したいので、リグレッションを防止したい

#### 受入基準

1. WHEN テストが実行される THEN URL組立・期間分割のユニットテストが実行される SHALL
2. WHEN HTMLスニペットのテストが実行される THEN 数値抽出処理のテストが実行される SHALL
3. WHEN Excel出力のテストが実行される THEN 存在・シート・列・チャート定義のスモークテストが実行される SHALL
4. WHEN PRが作成される THEN 代表的な3つのテストが緑色になる SHALL

### 要件7：パフォーマンス最適化（オプション）

**ユーザーストーリー：** ユーザーとして、データ取得の処理時間を短縮したいので、効率的な通信を行いたい

#### 受入基準

1. WHEN HTTP通信が実行される THEN `requests.Session()` を使用して接続を再利用する SHALL
2. WHEN 複数観測所のデータ取得が実行される THEN `concurrent.futures` を使用して並列処理する SHALL
3. WHEN パフォーマンス改善が適用される THEN 代表ケースで体感改善があり、失敗率が増加しない SHALL

### 要件8：コード品質とCI（オプション）

**ユーザーストーリー：** 開発者として、コード品質を維持したいので、静的解析とCIを導入したい

#### 受入基準

1. WHEN 開発環境が構築される THEN Ruff・Black・mypyが導入される SHALL
2. WHEN 主要APIが実装される THEN 型アノテーションが追加される SHALL
3. WHEN PRが作成される THEN GitHub Actionsでlint・testワークフローが自動実行される SHALL
4. WHEN リリースが実行される THEN 現行のタグ駆動ビルドが維持される SHALL

### 要件9：互換性の維持

**ユーザーストーリー：** 既存ユーザーとして、現在の使用方法を変更したくないので、外部仕様を維持してほしい

#### 受入基準

1. WHEN CLIオプションが使用される THEN 既存の `--single-sheet` オプションが動作する SHALL
2. WHEN Excel出力が実行される THEN 既存と同じファイル形式・シート構造・列名が維持される SHALL
3. WHEN リファクタリングが実行される THEN 既存利用者への影響が最小限に抑えられる SHALL
4. WHEN 問題が発生する THEN PR単位でリバートが可能である SHALL