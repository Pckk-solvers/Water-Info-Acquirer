# 実装計画

- [ ] 1. プロジェクト構造とコア統合の準備
  - 新しいwiaパッケージディレクトリ構造を作成
  - 基本的な__init__.pyファイルとモジュールスケルトンを作成
  - _要件: 1.1, 5.1, 5.2_

- [ ] 2. データ取得コアの統合実装
  - [ ] 2.1 定数・設定管理モジュールの実装
    - constants.pyにMODE_CONFIG、URL設定、Excel設定を定義
    - モード別の設定（num、base_url、unit、file_suffix）をテーブル化
    - _要件: 1.2, 1.3_

  - [ ] 2.2 型定義とデータモデルの実装
    - types.pyにDataRequest、StationInfo、ExcelOptions等のdataclassを定義
    - 時系列データの標準化されたDataFrame構造を定義
    - _要件: 1.1, 1.2_

  - [ ] 2.3 データ取得の統合レイヤ実装
    - data_source.pyにfetch_station_info関数を実装
    - 観測所名抽出の共通ロジックを実装（get_text(strip=True)基準）
    - generate_url関数で統一されたURL生成を実装
    - _要件: 1.1, 1.3, 1.4_

  - [ ] 2.4 時系列データ取得の統合実装
    - fetch_timeseries_data関数で日次・時間次データ取得を統合
    - HTML解析とpd.to_numeric(errors="coerce")による数値化を標準化
    - 既存のprocess_data_for_codeとprocess_period_date_display_for_codeを新APIで置換
    - _要件: 1.1, 1.4, 1.5, 1.6_

  - [ ] 2.5 データ取得のユニットテスト実装
    - URL生成ロジックのテスト
    - HTMLスニペット→数値抽出のテスト
    - 期間分割処理のテスト
    - _要件: 6.1, 6.2_

- [ ] 3. Excel出力の共通化実装
  - [ ] 3.1 エラーハンドリングモジュールの実装
    - errors.pyにEmptyDataError等の例外クラスを定義
    - 既存のEmptyExcelWarningを新しい例外体系に移行
    - _要件: 4.3, 9.1_

  - [ ] 3.2 Excel出力の統合レイヤ実装
    - excel_writer.pyにwrite_timeseries_excel関数を実装
    - ファイル名生成の標準化を実装
    - 全期間・年別・summaryシートの統一出力ロジックを実装
    - _要件: 2.1, 2.2, 2.3_

  - [ ] 3.3 散布図挿入の共通化実装
    - insert_chart関数で軸・凡例・サイズの共通設定を実装
    - 既存のチャート作成ロジックを統一APIで置換
    - single-sheetモード対応を統合
    - _要件: 2.1, 2.2, 2.4_

  - [ ] 3.4 既存Excel出力の新API置換
    - main_datetime.pyとdatemode.pyのExcel出力を新APIに置換
    - 出力Excelのシート名・列名・チャート有無の一致確認
    - _要件: 2.3, 9.2_

  - [ ] 3.5 Excel出力のスモークテスト実装
    - Excel存在・シート・列・チャート定義の確認テスト
    - 既存出力との比較テスト
    - _要件: 6.3_

- [ ] 4. GUI分離とビジネスロジック統合
  - [ ] 4.1 統合実行APIの実装
    - execute_data_acquisition関数でデータ取得・Excel出力を統合
    - 複数観測所の処理フローを実装
    - エラーハンドリングの統一
    - _要件: 3.1, 3.2_

  - [ ] 4.2 GUIの分離実装
    - gui.pyにWWRAppクラスを移動
    - UIコンポーネントと統合APIの接続
    - エラー表示・結果表示の統一
    - _要件: 3.1, 3.2, 3.3_

  - [ ] 4.3 CLIエントリーポイントの更新
    - __main__.pyを新しい統合APIに対応
    - --single-sheetオプションの動作確認
    - _要件: 3.4, 9.1_

- [ ] 5. ログとエラーハンドリングの整備
  - [ ] 5.1 ログシステムの実装
    - 標準loggingモジュールの設定（INFO/ERROR、ファイル+コンソール）
    - 各モジュールでのログ出力の実装
    - _要件: 4.1, 4.2_

  - [ ] 5.2 例外ハンドリングの統一
    - 業務例外（空データ）のGUI/CLI別対応実装
    - 想定外例外のログ記録と短文通知実装
    - CLI・GUI双方での一貫した挙動確保
    - _要件: 4.3, 4.4, 4.5_

- [ ] 6. パッケージ構造の最終移行
  - [ ] 6.1 テスト環境の整備
    - pytest設定とテストディレクトリ構造の作成
    - テスト実行用の依存関係追加（pytest、pytest-mock等）
    - テストカバレッジ測定の設定
    - _要件: 6.1, 6.4_

  - [ ] 6.2 最終ディレクトリ構造への移行
    - src/wia/配下への全モジュール配置
    - import文の整理とパッケージ初期化
    - _要件: 5.1, 5.2_

  - [ ] 6.3 ビルドプロセスの確認
    - python -m src.__main__の動作確認
    - PyInstallerビルドの成功確認
    - _要件: 5.3, 5.4_

  - [ ] 6.4 既存ファイルのクリーンアップ
    - 旧実装ファイルの削除または非推奨化
    - 最終的な動作確認とテスト実行
    - _要件: 5.1, 5.2_

- [ ] 7. 包括的テストスイートの実装
  - [ ] 7.1 GUI分離のテスト実装
    - WWRAppクラスの単体テスト
    - エラー表示・結果表示のテスト
    - ユーザー入力バリデーションのテスト
    - _要件: 3.1, 3.2, 3.3_

  - [ ] 7.2 エラーハンドリングのテスト実装
    - 各例外クラスの動作テスト
    - GUI・CLI別のエラー対応テスト
    - ログ出力の確認テスト
    - _要件: 4.3, 4.4, 4.5_

  - [ ] 7.3 統合テストの実装
    - データ取得から Excel出力までのエンドツーエンドテスト
    - 複数観測所の処理フローテスト
    - エラーケースの統合テスト
    - _要件: 6.4_

  - [ ] 7.4 回帰テストの実装
    - 既存機能との出力比較テスト
    - CLI・GUIの基本動作確認テスト
    - PyInstallerビルド後の動作テスト
    - _要件: 6.4, 9.3_

  - [ ] 7.5 テストデータとフィクスチャの整備
    - HTMLスニペットのテストフィクスチャ作成
    - モックデータとスタブの実装
    - テスト用の観測所コードとサンプルデータ準備
    - _要件: 6.1, 6.2, 6.3_

  - [ ] 7.6 テストカバレッジの確保
    - 各モジュールの単体テストカバレッジ80%以上達成
    - 重要なエラーパスのテストカバレッジ確認
    - テストレポートの生成と品質確認
    - _要件: 6.4_

- [ ] 8. パフォーマンス最適化（オプション）
  - [ ] 8.1 HTTP通信の最適化
    - requests.Session()による接続再利用の実装
    - 通信エラーハンドリングの改善
    - _要件: 7.1, 7.3_

  - [ ] 8.2 並列処理の実装
    - concurrent.futuresによる観測所別並列処理
    - エラー処理と結果集約の実装
    - _要件: 7.2, 7.3_

- [ ] 9. コード品質とCI整備（オプション）
  - [ ] 9.1 静的解析ツールの導入
    - Ruff・Black・mypyの開発環境導入
    - 主要APIへの型アノテーション追加
    - _要件: 8.1, 8.2_

  - [ ] 9.2 CI/CDワークフローの実装
    - GitHub Actionsでのlint・testワークフロー作成
    - 既存のタグ駆動ビルドとの共存確認
    - _要件: 8.3, 8.4_